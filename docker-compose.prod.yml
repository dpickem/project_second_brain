# =============================================================================
# Second Brain - Production Docker Compose Override
# =============================================================================
#
# This file is designed to be used WITH docker-compose.yml as a production
# override. It applies production-specific settings:
#
#   - Database ports NOT exposed to host (only accessible within Docker network)
#   - Resource limits (CPU, memory) for all services
#   - Network isolation with explicit network configuration
#   - Restart policies for high availability
#
# USAGE:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Or set COMPOSE_FILE environment variable:
#   export COMPOSE_FILE=docker-compose.yml:docker-compose.prod.yml
#   docker compose up -d
#
# PREREQUISITES:
#   - Copy .env.example to .env and configure production values
#   - Review and adjust resource limits based on your server capacity
#   - Set DEBUG=false in .env
#   - Set strong passwords for all databases
#   - Configure CORS_ORIGINS for your domain(s)
#
# SECURITY NOTES:
#   - Database ports (5432, 6379, 7474, 7687) are NOT exposed in production
#   - Only frontend (3000), backend (8000), and capture-pwa (5174) are exposed
#   - Use a reverse proxy (nginx) in front of these for SSL termination
#   - See docs/deployment/production.md for full deployment guide
#
# RESOURCE LIMITS:
#   Adjust based on your server capacity. Current defaults assume a server with:
#   - 8GB RAM minimum
#   - 4 CPU cores minimum
#
# =============================================================================

services:
  # ===========================================================================
  # PostgreSQL - No port exposure in production
  # ===========================================================================
  postgres:
    # Remove host port mapping (only accessible within Docker network)
    ports: !override []
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
    # Production-ready PostgreSQL settings
    command: >
      postgres
      -c max_connections=100
      -c shared_buffers=256MB
      -c effective_cache_size=768MB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200

  # ===========================================================================
  # Redis - No port exposure in production
  # ===========================================================================
  redis:
    ports: !override []
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 64M
    # Production Redis settings with memory limit
    command: >
      redis-server
      --appendonly yes
      --maxmemory 400mb
      --maxmemory-policy volatile-lru

  # ===========================================================================
  # Neo4j - No port exposure in production
  # ===========================================================================
  neo4j:
    # Remove host port mappings (only accessible within Docker network)
    ports: !override []
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 512M
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      # Production JVM settings
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=512m
      - NEO4J_server_memory_pagecache_size=256m

  # ===========================================================================
  # Backend API
  # ===========================================================================
  backend:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    environment:
      # Ensure debug is off in production
      DEBUG: "false"

  # ===========================================================================
  # Celery Workers
  # ===========================================================================
  celery-worker-1:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  celery-worker-2:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  # ===========================================================================
  # Frontend - Production build served by nginx
  # ===========================================================================
  frontend:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    # In production, remove hot reload volume mounts
    volumes: !override []

  # ===========================================================================
  # Capture PWA
  # ===========================================================================
  capture-pwa:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    # In production, remove hot reload volume mounts
    volumes: !override []

# =============================================================================
# Network Configuration
# =============================================================================
# In production, services communicate over an internal network.
# Only frontend, backend, and capture-pwa are exposed to the host.
#
# Network topology:
#   ┌─────────────────────────────────────────────────────────┐
#   │                    Docker Network                        │
#   │  ┌──────────┐  ┌──────────┐  ┌──────────┐               │
#   │  │ postgres │  │  redis   │  │  neo4j   │               │
#   │  │ (5432)   │  │ (6379)   │  │(7474,7687)│              │
#   │  └────┬─────┘  └────┬─────┘  └────┬─────┘               │
#   │       │             │             │                      │
#   │       └─────────────┼─────────────┘                      │
#   │                     │                                    │
#   │               ┌─────┴─────┐                              │
#   │               │  backend  │←────── Celery workers        │
#   │               │  (8000)   │                              │
#   │               └─────┬─────┘                              │
#   │                     │                                    │
#   │  ┌──────────────────┼───────────────────┐               │
#   │  │                  │                   │               │
#   │  ▼                  ▼                   ▼               │
#   │ frontend        backend API        capture-pwa          │
#   │ (3000)          (8000)             (5174)               │
#   └───┬────────────────┬────────────────┬───────────────────┘
#       │                │                │
#       ▼                ▼                ▼
#   [Host ports exposed - use reverse proxy for SSL]
# =============================================================================
